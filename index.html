<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>都庁モデルAR（直感的回転ハンドル付き）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://hammerjs.github.io/dist/hammer.min.js"></script>
  <style>
    body { margin:0; overflow:hidden; }
    .arjs-loader { 
      height:100%; width:100%; 
      position:absolute; top:0; left:0; 
      background:rgba(0,0,0,0.8); 
      z-index:9999; 
      display:flex; 
      justify-content:center; 
      align-items:center; 
    }
    .arjs-loader div { 
      color:white; 
      font-size:1.2em; 
      text-align: center;
    }
    .guide {
      position: absolute;
      top: 10px;
      left: 0;
      width: 100vw;
      text-align: center;
      z-index: 10000;
      color: #fff;
      background: rgba(0,0,0,0.6);
      font-size: 1.1em;
      padding: 8px 0;
    }
    .marker-img {
      width: 120px;
      margin: 10px auto;
      display: block;
      border: 2px solid #fff;
      background: #fff;
    }
    #scale-slider-wrap {
      position: absolute; 
      left: 50%; 
      bottom: 80px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.6); 
      padding: 10px 15px; 
      border-radius: 8px; 
      z-index: 10000; 
      display: none;
    }
    #scale-slider {
      width: 200px;
      margin-bottom: 5px;
    }
    #scale-slider-label {
      color: #fff;
      text-align: center;
      display: block;
      font-size: 0.9em;
    }
    /* 回転ハンドルUI */
    #rotate-handle-ui {
      position: absolute;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      z-index: 10001;
      display: none;
      pointer-events: none;
    }
    #rotate-handle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255,255,255,0.7);
      border: 3px solid #3498db;
      box-shadow: 0 0 8px #3498db;
      position: relative;
      pointer-events: auto;
      touch-action: none;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
    }
    #rotate-handle:after {
      content: '';
      display: block;
      width: 40px;
      height: 4px;
      background: #3498db;
      border-radius: 2px;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) rotate(0deg);
    }
    #rotate-guide-label {
      color: #3498db;
      font-size: 0.9em;
      text-align: center;
      margin-top: 4px;
      font-weight: bold;
      text-shadow: 0 0 4px #fff;
    }
  </style>
</head>
<body>
  <!-- ローディング表示 -->
  <div class="arjs-loader">
    <div>
      モデルを読み込み中です…<br>
      Loading, please wait...
    </div>
  </div>
  
  <!-- ガイド部分 -->
  <div class="guide" id="guide">
    <b>【ARガイド】</b><br>
    下のマーカー画像を印刷または別端末で表示し、カメラで映してください。<br>
    <img src="marker/qrmarker.png" class="marker-img" alt="ARマーカー">
    <span style="font-size:0.9em;">カメラ使用を許可してください／Allow camera access if prompted.</span>
  </div>
  
  <!-- スライダーでモデルサイズ調整 -->
  <div id="scale-slider-wrap">
    <input type="range" min="0.005" max="0.05" step="0.001" value="0.01" id="scale-slider">
    <label id="scale-slider-label" for="scale-slider">モデルサイズ調整</label>
  </div>
  
  <!-- 回転ハンドルUI -->
  <div id="rotate-handle-ui">
    <div id="rotate-handle"></div>
    <div id="rotate-guide-label">円をなぞってモデルを回転</div>
  </div>

  <!-- A-Frame AR.jsシーン -->
  <a-scene
    embedded
    arjs="sourceType: webcam; debugUIEnabled:false; detectionMode: mono_and_matrix;"
    renderer="logarithmicDepthBuffer: true; precision: medium;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: true"
  >
    <a-assets>
      <a-asset-item id="city" src="model/citymodel.glb"></a-asset-item>
    </a-assets>
    
    <a-marker type="pattern" url="marker/pattern-qrmarker.patt" id="my-marker">
      <a-entity
        id="model-entity"
        gltf-model="#city"
        scale="0.01 0.01 0.01"
        position="0 0 0"
        rotation="0 0 0"
        shadow="cast: false; receive: false"
      ></a-entity>
    </a-marker>
    
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const loader = document.querySelector('.arjs-loader');
      const scene = document.querySelector('a-scene');
      const guide = document.getElementById('guide');
      const marker = document.getElementById('my-marker');
      const modelEntity = document.getElementById('model-entity');
      const scaleSlider = document.getElementById('scale-slider');
      const scaleSliderWrap = document.getElementById('scale-slider-wrap');
      const rotateHandleUI = document.getElementById('rotate-handle-ui');
      const rotateHandle = document.getElementById('rotate-handle');

      // ローディング非表示
      scene.addEventListener('loaded', () => {
        loader.style.display = 'none';
      });

      // マーカー認識時にUI表示
      marker.addEventListener("markerFound", () => {
        guide.style.display = "none";
        scaleSliderWrap.style.display = "block";
        rotateHandleUI.style.display = "block";
      });

      marker.addEventListener("markerLost", () => {
        scaleSliderWrap.style.display = "none";
        rotateHandleUI.style.display = "none";
      });

      // スケール調整
      scaleSlider.addEventListener('input', (e) => {
        const scaleValue = parseFloat(e.target.value);
        modelEntity.setAttribute('scale', `${scaleValue} ${scaleValue} ${scaleValue}`);
      });
      scaleSlider.value = 0.01;

      // 回転ハンドル（Hammer.jsでジェスチャー検出）
      let lastAngle = 0;
      let currentRotation = 0;
      let isRotating = false;

      // Hammer.js初期化
      const hammer = new Hammer(rotateHandle, {
        recognizers: [
          [Hammer.Pan, { direction: Hammer.DIRECTION_ALL }]
        ]
      });

      // タッチ開始時の中心座標を取得
      function getCenter(el) {
        const rect = el.getBoundingClientRect();
        return {
          x: rect.left + rect.width / 2,
          y: rect.top + rect.height / 2
        };
      }

      // 角度計算
      function calcAngle(cx, cy, x, y) {
        return Math.atan2(y - cy, x - cx) * 180 / Math.PI;
      }

      hammer.on('panstart', function (e) {
        isRotating = true;
        const center = getCenter(rotateHandle);
        lastAngle = calcAngle(center.x, center.y, e.center.x, e.center.y);
      });

      hammer.on('panmove', function (e) {
        if (!isRotating) return;
        const center = getCenter(rotateHandle);
        const angle = calcAngle(center.x, center.y, e.center.x, e.center.y);
        let delta = angle - lastAngle;
        // 0-360度に正規化
        currentRotation += delta;
        if (currentRotation > 360) currentRotation -= 360;
        if (currentRotation < 0) currentRotation += 360;
        modelEntity.setAttribute('rotation', `0 ${currentRotation} 0`);
        lastAngle = angle;
      });

      hammer.on('panend pancancel', function () {
        isRotating = false;
      });
    });
  </script>
</body>
</html>
